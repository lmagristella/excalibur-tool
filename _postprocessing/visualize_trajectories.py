#!/usr/bin/env python3
"""
Visualization script for backward ray tracing trajectories.

This script loads and visualizes photon trajectories from the backward_raytracing_trajectories.h5
file generated by the excalibur library. It provides multiple visualization options including:
- 3D trajectory plots
- 2D projections 
- Time evolution animations
- Statistical analysis plots
"""

import numpy as np
import matplotlib.pyplot as plt
import matplotlib.animation as animation
from mpl_toolkits.mplot3d import Axes3D
import h5py
import sys
import os

# Add the project root to the path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

from excalibur.core.constants import one_Mpc
from excalibur.io.visualization import TrajectoryVisualizer

def main():
    """Main function for trajectory visualization."""
    
    # Configuration - look for files matching the pattern
    import glob
    pattern = "../_data/output/excalibur_run_perturbed_flrw_M1.0e15_R5.0_mass500_500_500_obs0_0_0_N*_sequential_S*_Mpc.h5"
    pattern = "/home/magri/excalibur_project/_data/output/excalibur_run_perturbed_flrw_M1.0e15_R5.0_mass500_500_500_obs0_0_0_N13_parallel_S5120_Mpc.h5"
    pattern = "/home/magri/_data/output/excalibur_run_perturbed_flrw_M1.0e15_R5.0_mass500_500_500_obs0_0_0_N463_parallel_S5120_Mpc.h5"
    pattern = "/home/magri/_data/output/excalibur_run_perturbed_flrw_M1.0e15_R5.0_mass500_500_500_obs0_0_0_N91_sequential_S5120_Mpc.h5"    
    pattern = "/home/magri/_data/output/excalibur_run_perturbed_flrw_M0.0e00_R5.0_mass500_500_500_obs0_0_0_N91_sequential_S5120_Mpc.h5"
    pattern = "/home/magri/excalibur_project/backward_raytracing_schwarzschild_clean_mass_4_4_4_Mpc.h5"

    files = glob.glob(pattern)
    
    print("=== Trajectory Visualization ===\n")
    
    # Check if files exist
    if not files:
        print(f"Error: No files matching '{pattern}' found!")
        print("Looking for files in ../data/output/...")
        # Also check current working directory
        pattern2 = "_data/output/excalibur_run_perturbed_flrw_*.h5"
        files = glob.glob(pattern2)
        if files:
            print(f"Found {len(files)} files in current directory")
        else:
            print("No files found in current directory either.")
            print("Please run the backward ray tracing simulation first.")
            return
    
    # Use the most recent file (or first if only one)
    filename = sorted(files)[-1]
    print(f"Using file: {filename}\n")
    
    # Create visualizer
    try:
        viz = TrajectoryVisualizer(filename)
    except Exception as e:
        print(f"Error loading trajectory data: {e}")
        return
    
    # Create visualizations
    print("\n" + "="*50)
    print("CREATING VISUALIZATIONS")
    print("="*50)
    
    # 1. 3D trajectory plot
    viz.plot_3d_trajectories(max_trajectories=30, save_file="trajectories_3d.png")
    
    # 2. 2D projections
    viz.plot_2d_projections(save_file="trajectories_2d.png")
    
    # 3. Time evolution
    viz.plot_time_evolution(save_file="trajectories_time.png")
    
    # 4. Statistical analysis
    viz.plot_statistics(save_file="trajectories_stats.png")
    
    # 5. Animation (optional - comment out if not needed)
    print("\nCreating animation (this may take a while)...")
    try:
        viz.create_animation(save_file="trajectories_animation.gif", 
                           interval=100, max_trajectories=10)
    except Exception as e:
        print(f"Animation creation failed: {e}")
        print("Skipping animation...")
    
    print("\n" + "="*50)
    print("VISUALIZATION COMPLETE")
    print("="*50)
    print("Generated files:")
    print("  - trajectories_3d.png      : 3D trajectory plot")
    print("  - trajectories_2d.png      : 2D projections")  
    print("  - trajectories_time.png    : Time evolution")
    print("  - trajectories_stats.png   : Statistical analysis")
    print("  - trajectories_animation.gif: Animation (if successful)")
    print("\nAll plots have been displayed and saved!")


if __name__ == "__main__":
    main()
